services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: pixav-postgres
    environment:
      POSTGRES_USER: pixav
      POSTGRES_PASSWORD: pixav
      POSTGRES_DB: pixav
    ports:
      - "${PIXAV_POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - pixav
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pixav"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: pixav-redis
    ports:
      - "${PIXAV_REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - pixav
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: pixav-qbittorrent
    environment:
      PUID: 1000
      PGID: 1000
      TZ: UTC
      # Keep container port == host port to avoid WebUI Host header validation issues.
      WEBUI_PORT: ${PIXAV_QBIT_PORT:-8085}
    ports:
      - "${PIXAV_QBIT_PORT:-8085}:${PIXAV_QBIT_PORT:-8085}"
      - "6881:6881"
      - "6881:6881/udp"
    volumes:
      - qbit-config:/config
      - ./data/downloads:/downloads
    networks:
      - pixav
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:$${WEBUI_PORT:-8080}/ >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: pixav-jackett
    environment:
      PUID: 1000
      PGID: 1000
      TZ: UTC
    ports:
      - "9117:9117"
    volumes:
      - jackett-config:/config
    networks:
      - pixav

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: pixav-flaresolverr
    ports:
      - "8191:8191"
    environment:
      LOG_LEVEL: info
      CAPTCHA_SOLVER: nodejs
    networks:
      - pixav

  stash:
    image: stashapp/stash:latest
    container_name: pixav-stash
    ports:
      - "9999:9999"
    environment:
      STASH_PORT: 9999
    volumes:
      - stash-config:/root/.stash
      - ./data/stash:/data
    networks:
      - pixav

  pixel_injector:
    build:
      context: .
      dockerfile: docker/pixel-injector.Dockerfile
    # Use host network so we can connect to spawned sibling containers on localhost mapped ports
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - postgres
      - redis
    environment:
      PIXAV_DB_HOST: localhost
      PIXAV_REDIS_URL: redis://localhost:6379/0
      # Ensure config matches internal docker network
      PIXAV_QUEUE_UPLOAD: pixav:upload
      PIXAV_QUEUE_UPLOAD_DLQ: pixav:upload:dlq
      # PIXAV_REDROID_NETWORK: pixav_pixav # No longer needed if using host ports

volumes:
  pgdata:
  redis-data:
  qbit-config:
  jackett-config:
  stash-config:

networks:
  pixav:
    driver: bridge
